<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aplikasi Pencarian Data Penduduk</title>
  <link rel="icon" type="image/png" href="https://res.cloudinary.com/dpr2vc3b0/image/upload/v1767107096/logo_donggala-fix-2025_napiej.png">
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">


    <!-- LAYAR LOGIN -->
    <div id="login-screen" class="bg-white p-8 rounded-lg shadow-md w-96 text-center">

        <h1 class="text-2xl font-bold mb-4 text-blue-600">Syamdigital</h1>
        <input type="password" id="passInput" placeholder="Masukkan Password" 
               class="w-full p-2 border rounded mb-4 focus:outline-blue-500">
        <button onclick="handleLogin()" 
                class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Masuk</button>
        <p id="errorMsg" class="text-red-500 mt-2 hidden text-sm">Password Salah!</p>

    </button>
<button type="button" onclick="togglePassword()" 
            class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-blue-600">
        <i id="eyeIcon" data-lucide="eye"></i>
</div>

    </div>

    <!-- LAYAR APLIKASI (Sembunyi di awal) -->
    <div id="app" class="hidden w-full max-w-4xl p-4 self-start mt-10">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-bold mb-4">Pencarian Data Penduduk</h2>
            
            <!-- Indikator Loading Data -->
            <div id="status-data" class="text-sm text-orange-500 mb-2 italic">
                ‚è≥ Menghubungkan ke Google Sheets...
            </div>

            <input type="text" id="searchInput" onkeyup="jalankanCari()"
                   placeholder="Cari Nama, NIK, atau Dusun..." 
                   class="w-full p-3 border-2 border-blue-200 rounded-lg focus:border-blue-500 outline-none mb-4" disabled>

            <div id="hasilPencarian" class="space-y-2 max-h-[500px] overflow-y-auto">
                <!-- Hasil Muncul di Sini -->
            </div>
        </div>
    </div>

    <script>
        let SEMUA_DATA = [];
        let MESIN_CARI;

        // 1. FUNGSI LOGIN
        async function handleLogin() {
            const password = document.getElementById('passInput').value;
            const res = await fetch('/api/auth', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ password })
            });

            if (res.ok) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                // Langsung panggil fungsi tarik data
                ambilDataSheets();
            } else {
                document.getElementById('errorMsg').classList.remove('hidden');
            }
        }

        // 2. FUNGSI TARIK DATA (TIDAK BLOCKING)
       

    async function fetchData() {
      try {
        const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRd3_sz649R1j66EVGQIzrBZa-fQJTR0IvBXiFXlI7nlFmQgbG__qVa9EUM5JUkalFQUXaT3oPLlv2Y/pubhtml?gid=0&single=true&output=csv';
        const response = await fetch(sheetUrl);
        
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        
        const csvText = await response.text();
        const data = parseCSV(csvText);
        
        return data;
      } catch (error) {
        try {
          const altUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRd3_sz649R1j66EVGQIzrBZa-fQJTR0IvBXiFXlI7nlFmQgbG__qVa9EUM5JUkalFQUXaT3oPLlv2Y/pub?output=csv';
          const response = await fetch(altUrl);
          const csvText = await response.text();
          const data = parseCSV(csvText);
          return data;
        } catch (fallbackError) {
          return [];
        }
      }
    }




        // 3. FUNGSI CARI KILAT
        function jalankanCari() {
            const kataKunci = document.getElementById('searchInput').value;
            const kontainerHasil = document.getElementById('hasilPencarian');

            if (!kataKunci) {
                kontainerHasil.innerHTML = "";
                return;
            }

            const hasil = MESIN_CARI.search(kataKunci);
            
            let html = "";
            hasil.slice(0, 20).forEach(r => {
                const p = r.item;
                html += `
                    <div class="p-3 border-b hover:bg-blue-50 cursor-pointer">
                        <p class="font-bold text-blue-800">${p.nama}</p>
                        <p class="text-xs text-gray-600">NIK: ${p.nik} | Dusun: ${p.dusun} | Umur: ${p.Umur}</p>
                    </div>
                `;
            });
            kontainerHasil.innerHTML = html || "<p class='text-gray-400'>Data tidak ditemukan...</p>";
        }
function togglePassword() {
    const passInput = document.getElementById('passInput');
    const eyeIcon = document.getElementById('eyeIcon');
    
    if (passInput.type === "password") {
        passInput.type = "text";
        eyeIcon.setAttribute('data-lucide', 'eye-off'); // Ganti ikon jadi mata coret
    } else {
        passInput.type = "password";
        eyeIcon.setAttribute('data-lucide', 'eye'); // Kembali ke mata terbuka
    }
    // Refresh ikon Lucide agar berubah
    lucide.createIcons();
}

// Tambahkan ini di bagian paling bawah script agar ikon muncul saat pertama buka
lucide.createIcons();

    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b9227fd77d3926c',t:'MTc2NzYwNzUxNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
<script>
<!-- WhatsApp Share Button -->
        <div class="mt-6 pt-6 border-t-2 border-gold-accent">
          <button 
            onclick="shareToWhatsApp('${nik.replace(/'/g, "\\'")}', '${nama.replace(/'/g, "\\'")}', '${no_kk.replace(/'/g, "\\'")}', '${jenisKelamin.replace(/'/g, "\\'")}', '${tempatLahir.replace(/'/g, "\\'")}', '${tanggalLahir.replace(/'/g, "\\'")}', '${umur}', '${agama.replace(/'/g, "\\'")}', '${dusun.replace(/'/g, "\\'")}', '${alamat.replace(/'/g, "\\'")}')"
            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-xl transition-all flex items-center justify-center gap-3 text-lg"
          >
            <span class="text-2xl">üì±</span>
            <span>Bagikan ke WhatsApp</span>
          </button>
        </div>
      `;
      
      modalOverlay.classList.remove('hidden');
    }

    function closeModal() {
      const modalOverlay = document.getElementById('modal-overlay');
      modalOverlay.classList.add('hidden');
    }

    function showExportModal() {
      const exportModalOverlay = document.getElementById('export-modal-overlay');
      const dusunList = document.getElementById('dusun-list');
      
      // Get unique dusun names
      const dusunNames = [...new Set(allData.map(d => d.dusun))].filter(Boolean).sort();
      
      if (dusunNames.length === 0) {
        showToast('Tidak ada data dusun untuk diekspor');
        return;
      }
      
      dusunList.innerHTML = dusunNames.map(dusun => {
        const count = allData.filter(d => d.dusun === dusun).length;
        const safeDusun = dusun.replace(/'/g, "\\'");
        return `
          <button 
            class="export-dusun-btn w-full result-card rounded-xl p-4 text-left hover:border-gold-accent transition-all"
            data-dusun="${safeDusun}"
          >
            <div class="flex justify-between items-center">
              <div>
                <h3 class="text-lg font-bold gold-accent">${dusun}</h3>
                <p class="text-gray-400 text-sm">${count} penduduk</p>
              </div>
              <div class="text-2xl">üìÑ</div>
            </div>
          </button>
        `;
      }).join('');
      
      // Add click event listeners to dusun buttons
      document.querySelectorAll('.export-dusun-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const dusun = btn.getAttribute('data-dusun');
          exportDusunToPDF(dusun);
        });
      });
      
      // Add export all button listener
      const exportAllButton = document.getElementById('export-all-button');
      if (exportAllButton) {
        // Remove existing listeners
        const newExportAllButton = exportAllButton.cloneNode(true);
        exportAllButton.parentNode.replaceChild(newExportAllButton, exportAllButton);
        
        // Add new listener
        newExportAllButton.addEventListener('click', () => {
          exportAllDusunToPDF();
        });
      }
      
      exportModalOverlay.classList.remove('hidden');
    }

    function closeExportModal() {
      const exportModalOverlay = document.getElementById('export-modal-overlay');
      exportModalOverlay.classList.add('hidden');
    }

    function shareToWhatsApp(nik, nama, no_kk, jenisKelamin, tempatLahir, tanggalLahir, umur, agama, dusun, alamat) {
      const message = `*DATA PENDUDUK*\n\n` +
        `üìã *Nama:* ${nama}\n` +
        `üÜî *NIK:* ${nik}\n` +
        `üë• *No. KK:* ${no_kk}\n` +
        `üë§ *Jenis Kelamin:* ${jenisKelamin}\n` +
        `üìÖ *Tempat/Tgl Lahir:* ${tempatLahir}, ${tanggalLahir}\n` +
        `üéÇ *Umur:* ${umur} tahun\n` +
        `üïå *Agama:* ${agama}\n` +
        `üìç *Dusun:* ${dusun}\n` +
        `üè† *Alamat:* ${alamat}\n\n` +
        `_Data dari Sistem Pencarian Data Penduduk_\n\n` +
        `‚ÑπÔ∏è Info selengkapnya: https://syam.digital/dataku`;
      
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
      
      window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
      
      showToast('Membuka WhatsApp...');
    }

    function exportAllDusunToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('landscape', 'mm', 'a4');
      
      if (allData.length === 0) {
        showToast('Tidak ada data untuk diekspor');
        return;
      }
      
      showToast('Membuat PDF untuk SEMUA DUSUN...');
      
      // Get unique dusun names
      const dusunNames = [...new Set(allData.map(d => d.dusun))].filter(Boolean).sort();
      
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 10;
      const contentWidth = pageWidth - (2 * margin);
      
      let currentPage = 1;
      let isFirstDusun = true;
      
      function drawHeader(pageNum, dusun) {
        // Header
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text('DATA PENDUDUK - SEMUA DUSUN', pageWidth / 2, 15, { align: 'center' });
        
        doc.setFontSize(12);
        doc.text(`DUSUN: ${dusun.toUpperCase()}`, pageWidth / 2, 22, { align: 'center' });
        
        const dusunData = allData.filter(d => d.dusun === dusun);
        const lakiLaki = dusunData.filter(d => d['Jenis Kelamin'] === '1' || d['Jenis Kelamin']?.toLowerCase() === 'laki-laki').length;
        const perempuan = dusunData.filter(d => d['Jenis Kelamin'] === '2' || d['Jenis Kelamin']?.toLowerCase() === 'perempuan').length;
        
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text(`Total Dusun Ini: ${dusunData.length} | Laki-laki: ${lakiLaki} | Perempuan: ${perempuan}`, pageWidth / 2, 28, { align: 'center' });
        doc.text(`Dicetak: ${new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })}`, pageWidth / 2, 33, { align: 'center' });
        
        // Page number
        doc.setFontSize(8);
        doc.text(`Halaman ${pageNum}`, pageWidth - margin, pageHeight - 5, { align: 'right' });
      }
      
      function drawTableHeader(startY) {
        const colWidths = [8, 50, 28, 14, 35, 10, 25, 30, 30, 50];
        let x = margin;
        
        doc.setFillColor(139, 0, 0);
        doc.rect(margin, startY, contentWidth, 8, 'F');
        
        doc.setTextColor(255, 215, 0);
        doc.setFontSize(7);
        doc.setFont(undefined, 'bold');
        
        const headers = ['NO', 'NAMA', 'NIK', 'JK', 'TTL', 'UMUR', 'AGAMA', 'PEKERJAAN', 'PENDIDIKAN', 'ALAMAT'];
        
        headers.forEach((header, i) => {
          doc.text(header, x + (colWidths[i] / 2), startY + 5.5, { align: 'center' });
          x += colWidths[i];
        });
        
        doc.setTextColor(0, 0, 0);
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.1);
        doc.rect(margin, startY, contentWidth, 8);
        
        let lineX = margin;
        for (let i = 0; i < colWidths.length - 1; i++) {
          lineX += colWidths[i];
          doc.line(lineX, startY, lineX, startY + 8);
        }
        
        return startY + 8;
      }
      
      // Process each dusun
      dusunNames.forEach((dusun, dusunIndex) => {
        const dusunData = allData.filter(d => d.dusun === dusun);
        
        if (!isFirstDusun) {
          doc.addPage();
          currentPage++;
        }
        isFirstDusun = false;
        
        drawHeader(currentPage, dusun);
        let y = drawTableHeader(38);
        
        const colWidths = [8, 50, 28, 14, 35, 10, 25, 30, 30, 50];
        const rowHeight = 6;
        
        dusunData.forEach((row, index) => {
          if (y > pageHeight - 20) {
            doc.addPage();
            currentPage++;
            drawHeader(currentPage, dusun);
            y = drawTableHeader(38);
          }
          
          const nama = row.nama || '-';
          const nik = row.nik || '-';
          const jenisKelamin = (row['Jenis Kelamin'] === '1' || row['Jenis Kelamin']?.toLowerCase() === 'laki-laki') ? 'L' : 'P';
          const tempatLahir = row.tempatlahir || '-';
          const tanggalLahir = row.tanggallahir || '-';
          const umur = row.Umur || row.umur || '-';
          const agama = row.agama || '-';
          const pekerjaan = row.pekerjaan_id || '-';
          const pendidikan = row.pendidikan_kk_id || '-';
          const alamat = row.alamat || '-';
          
          const ttl = `${tempatLahir}, ${tanggalLahir}`;
          
          doc.setFontSize(6.5);
          doc.setFont(undefined, 'normal');
          
          let x = margin;
          
          // NO
          doc.text(String(index + 1), x + (colWidths[0] / 2), y + 4, { align: 'center' });
          x += colWidths[0];
          
          // NAMA
          const namaLines = doc.splitTextToSize(nama, colWidths[1] - 2);
          doc.text(namaLines[0] || nama, x + 1, y + 4);
          x += colWidths[1];
          
          // NIK
          doc.text(nik, x + 1, y + 4);
          x += colWidths[2];
          
          // JK
          doc.text(jenisKelamin, x + (colWidths[3] / 2), y + 4, { align: 'center' });
          x += colWidths[3];
          
          // TTL
          const ttlLines = doc.splitTextToSize(ttl, colWidths[4] - 2);
          if (ttlLines.length > 1) {
            doc.text(ttlLines[0], x + 1, y + 2.5);
            doc.text(ttlLines[1], x + 1, y + 5);
          } else {
            doc.text(ttlLines[0] || ttl, x + 1, y + 4);
          }
          x += colWidths[4];
          
          // UMUR
          doc.text(String(umur), x + (colWidths[5] / 2), y + 4, { align: 'center' });
          x += colWidths[5];
          
          // AGAMA
          doc.text(agama, x + 1, y + 4);
          x += colWidths[6];
          
          // PEKERJAAN
          const pekerjaanLines = doc.splitTextToSize(pekerjaan, colWidths[7] - 2);
          doc.text(pekerjaanLines[0] || pekerjaan, x + 1, y + 4);
          x += colWidths[7];
          
          // PENDIDIKAN
          const pendidikanLines = doc.splitTextToSize(pendidikan, colWidths[8] - 2);
          doc.text(pendidikanLines[0] || pendidikan, x + 1, y + 4);
          x += colWidths[8];
          
          // ALAMAT
          const alamatLines = doc.splitTextToSize(alamat, colWidths[9] - 2);
          doc.text(alamatLines[0] || alamat, x + 1, y + 4);
          
          // Draw row borders
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.1);
          doc.rect(margin, y, contentWidth, rowHeight);
          
          let lineX = margin;
          for (let i = 0; i < colWidths.length - 1; i++) {
            lineX += colWidths[i];
            doc.line(lineX, y, lineX, y + rowHeight);
          }
          
          y += rowHeight;
        });
      });
      
      // Add summary page at the end
      doc.addPage();
      currentPage++;
      
      doc.setFontSize(18);
      doc.setFont(undefined, 'bold');
      doc.text('RINGKASAN DATA SEMUA DUSUN', pageWidth / 2, 20, { align: 'center' });
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      
      const totalPenduduk = allData.length;
      const totalLakiLaki = allData.filter(d => d['Jenis Kelamin'] === '1' || d['Jenis Kelamin']?.toLowerCase() === 'laki-laki').length;
      const totalPerempuan = allData.filter(d => d['Jenis Kelamin'] === '2' || d['Jenis Kelamin']?.toLowerCase() === 'perempuan').length;
      
      let summaryY = 40;
      
      doc.text(`Total Penduduk: ${totalPenduduk} orang`, margin, summaryY);
      summaryY += 8;
      doc.text(`Laki-laki: ${totalLakiLaki} orang`, margin, summaryY);
      summaryY += 8;
      doc.text(`Perempuan: ${totalPerempuan} orang`, margin, summaryY);
      summaryY += 8;
      doc.text(`Jumlah Dusun: ${dusunNames.length}`, margin, summaryY);
      summaryY += 15;
      
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.text('Rincian per Dusun:', margin, summaryY);
      summaryY += 10;
      
      doc.setFontSize(9);
      doc.setFont(undefined, 'normal');
      
      dusunNames.forEach((dusun, index) => {
        const dusunData = allData.filter(d => d.dusun === dusun);
        const lakiLaki = dusunData.filter(d => d['Jenis Kelamin'] === '1' || d['Jenis Kelamin']?.toLowerCase() === 'laki-laki').length;
        const perempuan = dusunData.filter(d => d['Jenis Kelamin'] === '2' || d['Jenis Kelamin']?.toLowerCase() === 'perempuan').length;
        
        doc.text(`${index + 1}. ${dusun}: ${dusunData.length} orang (L: ${lakiLaki}, P: ${perempuan})`, margin + 5, summaryY);
        summaryY += 6;
        
        if (summaryY > pageHeight - 20) {
          doc.addPage();
          currentPage++;
          summaryY = 20;
        }
      });
      
      doc.setFontSize(8);
      doc.text(`Halaman ${currentPage}`, pageWidth - margin, pageHeight - 5, { align: 'right' });
      
      // Save PDF
      const filename = `Data_Penduduk_SEMUA_DUSUN_${new Date().getTime()}.pdf`;
      doc.save(filename);
      
      closeExportModal();
      showToast(`PDF SEMUA DUSUN berhasil diunduh! Total ${dusunNames.length} dusun.`);
    }

    function exportDusunToPDF(dusun) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('landscape', 'mm', 'a4');
      
      // Filter data by dusun
      const dusunData = allData.filter(d => d.dusun === dusun);
      
      if (dusunData.length === 0) {
        showToast('Tidak ada data untuk dusun ini');
        return;
      }
      
      showToast(`Membuat PDF untuk Dusun ${dusun}...`);
      
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 10;
      const contentWidth = pageWidth - (2 * margin);
      
      let currentPage = 1;
      
      function drawHeader(pageNum) {
        // Header
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text('DATA PENDUDUK', pageWidth / 2, 15, { align: 'center' });
        
        doc.setFontSize(12);
        doc.text(`DUSUN: ${dusun.toUpperCase()}`, pageWidth / 2, 22, { align: 'center' });
        
        // Statistics
        const lakiLaki = dusunData.filter(d => d['Jenis Kelamin'] === '1' || d['Jenis Kelamin']?.toLowerCase() === 'laki-laki').length;
        const perempuan = dusunData.filter(d => d['Jenis Kelamin'] === '2' || d['Jenis Kelamin']?.toLowerCase() === 'perempuan').length;
        
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text(`Total: ${dusunData.length} | Laki-laki: ${lakiLaki} | Perempuan: ${perempuan}`, pageWidth / 2, 28, { align: 'center' });
        doc.text(`Dicetak: ${new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })}`, pageWidth / 2, 33, { align: 'center' });
        
        // Page number
        doc.setFontSize(8);
        doc.text(`Halaman ${pageNum}`, pageWidth - margin, pageHeight - 5, { align: 'right' });
      }
      
      function drawTableHeader(startY) {
        const colWidths = [8, 50, 28, 14, 35, 10, 25, 30, 30, 50];
        let x = margin;
        
        doc.setFillColor(139, 0, 0);
        doc.rect(margin, startY, contentWidth, 8, 'F');
        
        doc.setTextColor(255, 215, 0);
        doc.setFontSize(7);
        doc.setFont(undefined, 'bold');
        
        const headers = ['NO', 'NAMA', 'NIK', 'JK', 'TTL', 'UMUR', 'AGAMA', 'PEKERJAAN', 'PENDIDIKAN', 'ALAMAT'];
        
        headers.forEach((header, i) => {
          doc.text(header, x + (colWidths[i] / 2), startY + 5.5, { align: 'center' });
          x += colWidths[i];
        });
        
        doc.setTextColor(0, 0, 0);
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.1);
        doc.rect(margin, startY, contentWidth, 8);
        
        let lineX = margin;
        for (let i = 0; i < colWidths.length - 1; i++) {
          lineX += colWidths[i];
          doc.line(lineX, startY, lineX, startY + 8);
        }
        
        return startY + 8;
      }
      
      drawHeader(currentPage);
      let y = drawTableHeader(38);
      
      const colWidths = [8, 50, 28, 14, 35, 10, 25, 30, 30, 50];
      const rowHeight = 6;
      
      dusunData.forEach((row, index) => {
        if (y > pageHeight - 20) {
          doc.addPage();
          currentPage++;
          drawHeader(currentPage);
          y = drawTableHeader(38);
        }
        
        const nama = row.nama || '-';
        const nik = row.nik || '-';
        const jenisKelamin = (row['Jenis Kelamin'] === '1' || row['Jenis Kelamin']?.toLowerCase() === 'laki-laki') ? 'L' : 'P';
        const tempatLahir = row.tempatlahir || '-';
        const tanggalLahir = row.tanggallahir || '-';
        const umur = row.Umur || row.umur || '-';
        const agama = row.agama || '-';
        const pekerjaan = row.pekerjaan_id || '-';
        const pendidikan = row.pendidikan_kk_id || '-';
        const alamat = row.alamat || '-';
        
        const ttl = `${tempatLahir}, ${tanggalLahir}`;
        
        doc.setFontSize(6.5);
        doc.setFont(undefined, 'normal');
        
        let x = margin;
        
        // NO
        doc.text(String(index + 1), x + (colWidths[0] / 2), y + 4, { align: 'center' });
        x += colWidths[0];
        
        // NAMA
        const namaLines = doc.splitTextToSize(nama, colWidths[1] - 2);
        doc.text(namaLines[0] || nama, x + 1, y + 4);
        x += colWidths[1];
        
        // NIK
        doc.text(nik, x + 1, y + 4);
        x += colWidths[2];
        
        // JK
        doc.text(jenisKelamin, x + (colWidths[3] / 2), y + 4, { align: 'center' });
        x += colWidths[3];
        
        // TTL - Split into two lines if needed
        const ttlLines = doc.splitTextToSize(ttl, colWidths[4] - 2);
        if (ttlLines.length > 1) {
          doc.text(ttlLines[0], x + 1, y + 2.5);
          doc.text(ttlLines[1], x + 1, y + 5);
        } else {
          doc.text(ttlLines[0] || ttl, x + 1, y + 4);
        }
        x += colWidths[4];
        
        // UMUR
        doc.text(String(umur), x + (colWidths[5] / 2), y + 4, { align: 'center' });
        x += colWidths[5];
        
        // AGAMA
        doc.text(agama, x + 1, y + 4);
        x += colWidths[6];
        
        // PEKERJAAN
        const pekerjaanLines = doc.splitTextToSize(pekerjaan, colWidths[7] - 2);
        doc.text(pekerjaanLines[0] || pekerjaan, x + 1, y + 4);
        x += colWidths[7];
        
        // PENDIDIKAN
        const pendidikanLines = doc.splitTextToSize(pendidikan, colWidths[8] - 2);
        doc.text(pendidikanLines[0] || pendidikan, x + 1, y + 4);
        x += colWidths[8];
        
        // ALAMAT
        const alamatLines = doc.splitTextToSize(alamat, colWidths[9] - 2);
        doc.text(alamatLines[0] || alamat, x + 1, y + 4);
        
        // Draw row borders
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.1);
        doc.rect(margin, y, contentWidth, rowHeight);
        
        let lineX = margin;
        for (let i = 0; i < colWidths.length - 1; i++) {
          lineX += colWidths[i];
          doc.line(lineX, y, lineX, y + rowHeight);
        }
        
        y += rowHeight;
      });
      
      // Save PDF
      const filename = `Data_Penduduk_${dusun.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().getTime()}.pdf`;
      doc.save(filename);
      
      closeExportModal();
      showToast(`PDF berhasil diunduh!`);
    }

    function displayResults(data) {
      const resultsContainer = document.getElementById('results');
      const loadingContainer = document.getElementById('loading');
      const noResultsContainer = document.getElementById('no-results');
      
      loadingContainer.classList.add('hidden');
      
      if (data.length === 0) {
        resultsContainer.innerHTML = '';
        noResultsContainer.classList.remove('hidden');
        return;
      }
      
      noResultsContainer.classList.add('hidden');
      
      resultsContainer.innerHTML = data.map((row, index) => {
        const nama = row.nama || '-';
        const nik = row.nik || '-';
        const jenisKelamin = row['Jenis Kelamin'] || '-';
        const tempatLahir = row.tempatlahir || '-';
        const tanggalLahir = row.tanggallahir || '-';
        const alamat = row.alamat || '-';
        const dusun = row.dusun || '-';
        const foto = row.foto || '';
        
        const genderIcon = (jenisKelamin.toLowerCase() === 'perempuan' || jenisKelamin === '2') ? 'üë©' : 'üë®';
        
        return `
          <div class="result-card rounded-xl p-6 shadow-lg cursor-pointer" data-index="${index}">
            <div class="flex items-center gap-3 mb-4">
              ${foto ? `
                <img 
                  src="${foto}" 
                  alt="Foto ${nama}" 
                  class="w-16 h-16 rounded-full object-cover border-2 border-gold-accent"
                  onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
                />
                <div class="text-3xl hidden">${genderIcon}</div>
              ` : `
                <div class="text-3xl">${genderIcon}</div>
              `}
              <div class="flex-1">
                <h3 class="text-xl font-bold gold-accent">${nama}</h3>
                <p class="text-gray-400 text-sm">NIK: ${nik}</p>
              </div>
            </div>
            
            <div class="space-y-2">
              <div class="flex justify-between items-start border-b border-gray-700 pb-2">
                <span class="text-gray-400 text-sm font-medium">Tempat/Tgl Lahir:</span>
                <span class="text-white text-sm text-right ml-4 max-w-xs break-words">${tempatLahir}, ${tanggalLahir}</span>
              </div>
              <div class="flex justify-between items-start border-b border-gray-700 pb-2">
                <span class="text-gray-400 text-sm font-medium">Alamat:</span>
                <span class="text-white text-sm text-right ml-4 max-w-xs break-words">${alamat}</span>
              </div>
              <div class="flex justify-between items-start border-b border-gray-700 pb-2">
                <span class="text-gray-400 text-sm font-medium">Dusun:</span>
                <span class="text-white text-sm text-right ml-4">${dusun}</span>
              </div>
            </div>
            
            <div class="mt-4 text-center">
              <span class="text-white text-sm font-bold">üëÜ Klik untuk lihat detail lengkap</span>
            </div>
          </div>
        `;
      }).join('');
      
      // Add click event listeners to result cards
      document.querySelectorAll('.result-card').forEach((card, index) => {
        card.addEventListener('click', () => {
          showModal(data[index]);
        });
      });
    }

    async function handleSearch(event) {
      event.preventDefault();
      
      if (isLoading) return;
      
      const searchInput = document.getElementById('search-input');
      const query = searchInput.value;
      
      const loadingContainer = document.getElementById('loading');
      const resultsContainer = document.getElementById('results');
      const noResultsContainer = document.getElementById('no-results');
      
      loadingContainer.classList.remove('hidden');
      resultsContainer.innerHTML = '';
      noResultsContainer.classList.add('hidden');
      
      if (allData.length === 0) {
        isLoading = true;
        allData = await fetchData();
        isLoading = false;
      }
      
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const results = searchData(query);
      
      // If search is empty, show all data in list
      if (!query.trim()) {
        displayResults(results);
        displayStats(results);
      }
      // If only one result found from search, show modal directly
      else if (results.length === 1) {
        loadingContainer.classList.add('hidden');
        showModal(results[0]);
        displayStats(results);
      } else {
        // Multiple or no results, show list
        displayResults(results);
        displayStats(results);
      }
    }

    function handleLogin(event) {
      event.preventDefault();
      
      const passwordInput = document.getElementById('password-input');
      const loginError = document.getElementById('login-error');
      const loginScreen = document.getElementById('login-screen');
      const appScreen = document.getElementById('app');
      
      const password = passwordInput.value.trim();
      const correctPassword = '7203192010#';
      
      if (password === correctPassword) {
        // Login successful
        loginError.classList.add('hidden');
        loginScreen.classList.add('hidden');
        appScreen.classList.remove('hidden');
        
        // Store login state
        sessionStorage.setItem('isLoggedIn', 'true');
        
        // Initialize main app
        initializeMainApp();
        
        showToast('Login berhasil! Selamat datang Admin.');
      } else {
        // Login failed
        loginError.classList.remove('hidden');
        passwordInput.value = '';
        passwordInput.focus();
      }
    }
    
    function handleLogout() {
      const loginScreen = document.getElementById('login-screen');
      const appScreen = document.getElementById('app');
      
      // Clear login state
      sessionStorage.removeItem('isLoggedIn');
      
      // Show login screen
      appScreen.classList.add('hidden');
      loginScreen.classList.remove('hidden');
      
      // Clear password input
      document.getElementById('password-input').value = '';
      
      showToast('Anda telah keluar dari sistem.');
    }
    
    async function initializeMainApp() {
      const searchForm = document.getElementById('search-form');
      const searchInput = document.getElementById('search-input');
      const clearSearchBtn = document.getElementById('clear-search');
      
      searchForm.addEventListener('submit', handleSearch);
      
      // Show/hide clear button based on input
      searchInput.addEventListener('input', () => {
        if (searchInput.value.trim()) {
          clearSearchBtn.classList.remove('hidden');
        } else {
          clearSearchBtn.classList.add('hidden');
        }
      });
      
      // Clear search functionality
      clearSearchBtn.addEventListener('click', () => {
        searchInput.value = '';
        clearSearchBtn.classList.add('hidden');
        searchInput.focus();
        
        // Reset to show all data
        displayResults(allData);
        displayStats(allData);
        
        showToast('Pencarian dihapus');
      });
      
      // Add export button listener
      const exportButton = document.getElementById('export-button');
      exportButton.addEventListener('click', showExportModal);
      
      // Add modal close listeners
      const closeModalBtn = document.getElementById('close-modal');
      const modalOverlay = document.getElementById('modal-overlay');
      
      closeModalBtn.addEventListener('click', closeModal);
      modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) {
          closeModal();
        }
      });
      
      // Add export modal close listeners
      const closeExportModalBtn = document.getElementById('close-export-modal');
      const exportModalOverlay = document.getElementById('export-modal-overlay');
      
      closeExportModalBtn.addEventListener('click', closeExportModal);
      exportModalOverlay.addEventListener('click', (e) => {
        if (e.target === exportModalOverlay) {
          closeExportModal();
        }
      });
      
      // Load data
      isLoading = true;
      document.getElementById('loading').classList.remove('hidden');
      allData = await fetchData();
      isLoading = false;
      displayResults(allData);
      displayStats(allData);
      
      // Generate alphabet filter buttons
      generateAlphabetFilter();
      
      // Initialize dropdown with all names
      updateDropdownOptions('ALL');
    }

    async function initialize() {
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities,
          mapToEditPanelValues
        });
      }
      
      // Check if already logged in
      const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
      
      if (isLoggedIn) {
        // Show app directly
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        initializeMainApp();
      } else {
        // Show login screen
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('app').classList.add('hidden');
      }
      
      // Add login form listener
      const loginForm = document.getElementById('login-form');
      loginForm.addEventListener('submit', handleLogin);
      
      // Add logout button listener
      const logoutButton = document.getElementById('logout-button');
      logoutButton.addEventListener('click', handleLogout);
      
      // Add toggle password visibility
      const togglePassword = document.getElementById('toggle-password');
      const passwordInput = document.getElementById('password-input');
      
      togglePassword.addEventListener('click', () => {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        togglePassword.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initialize);
    } else {
      initialize();
    }
  </script>
</body>
</html>
